#!/usr/bin/env node
/**
 * Sync script to copy docs-control JSON exports from share/exports/docs-control
 * to webui/graph/public/exports/docs-control for static serving.
 * 
 * This ensures that when the web UI fetches /exports/docs-control/*.json,
 * it receives the actual files generated by `pmagent docs dashboard-refresh`.
 */

import { copyFileSync, mkdirSync, readdirSync, statSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Paths relative to repo root
const repoRoot = join(__dirname, '../../..');
const sourceDir = join(repoRoot, 'share/exports/docs-control');
const lmSourceDir = join(repoRoot, 'share/atlas/control_plane');
const dbSourceDir = join(repoRoot, 'share/evidence');
const autopilotSourceDir = join(repoRoot, 'share/autopilot');
const biblescholarSourceDir = join(repoRoot, 'share/exports/biblescholar');
const graphSourceDir = join(repoRoot, 'share/exports');

const targetDir = join(repoRoot, 'webui/graph/public/exports/docs-control');
const lmTargetDir = join(repoRoot, 'webui/graph/public/exports/control-plane');
const dbTargetDir = join(repoRoot, 'webui/graph/public/exports/evidence');
const autopilotTargetDir = join(repoRoot, 'webui/graph/public/exports/autopilot');
const biblescholarTargetDir = join(repoRoot, 'webui/graph/public/exports/biblescholar');
const graphTargetDir = join(repoRoot, 'webui/graph/public/exports');

function syncFiles() {
  try {
    // Ensure target directory exists
    mkdirSync(targetDir, { recursive: true });

    // Check if source directory exists
    if (!statSync(sourceDir).isDirectory()) {
      console.warn(`Source directory does not exist: ${sourceDir}`);
      console.warn('Run `pmagent docs dashboard-refresh` to generate exports first.');
      return;
    }

    // Copy all JSON files from source to target
    const files = readdirSync(sourceDir).filter(f => f.endsWith('.json'));

    if (files.length === 0) {
      console.warn(`No JSON files found in ${sourceDir}`);
      console.warn('Run `pmagent docs dashboard-refresh` to generate exports first.');
      return;
    }

    let copied = 0;
    for (const file of files) {
      const sourcePath = join(sourceDir, file);
      const targetPath = join(targetDir, file);
      copyFileSync(sourcePath, targetPath);
      copied++;
      console.log(`Copied: ${file}`);
    }

    console.log(`\nâœ“ Synced ${copied} file(s) to ${targetDir}`);

    // Sync LM Indicator, System Health, and Autopilot Summary
    mkdirSync(lmTargetDir, { recursive: true });
    if (statSync(join(lmSourceDir, 'lm_indicator.json')).isFile()) {
      copyFileSync(join(lmSourceDir, 'lm_indicator.json'), join(lmTargetDir, 'lm_indicator.json'));
      console.log(`Copied: lm_indicator.json`);
    }
    if (statSync(join(lmSourceDir, 'system_health.json')).isFile()) {
      copyFileSync(join(lmSourceDir, 'system_health.json'), join(lmTargetDir, 'system_health.json'));
      console.log(`Copied: system_health.json`);
    }
    if (statSync(join(lmSourceDir, 'autopilot_summary.json')).isFile()) {
      copyFileSync(join(lmSourceDir, 'autopilot_summary.json'), join(lmTargetDir, 'autopilot_summary.json'));
      console.log(`Copied: autopilot_summary.json`);
    }

    // Sync DB Health (using latest guard_all_validation as proxy if needed, or specific db health file)
    // For now, we'll look for the latest guard_all_validation which contains DB checks
    mkdirSync(dbTargetDir, { recursive: true });
    const evidenceFiles = readdirSync(dbSourceDir).filter(f => f.startsWith('guard_all_validation') && f.endsWith('.json'));
    if (evidenceFiles.length > 0) {
      // Sort by name (timestamp) descending
      evidenceFiles.sort().reverse();
      const latest = evidenceFiles[0];
      copyFileSync(join(dbSourceDir, latest), join(dbTargetDir, 'latest_guard_validation.json'));
      console.log(`Copied: ${latest} -> latest_guard_validation.json`);
    }

    // Sync Autopilot logs
    mkdirSync(autopilotTargetDir, { recursive: true });
    try {
      if (statSync(autopilotSourceDir).isDirectory()) {
        const autopilotFiles = readdirSync(autopilotSourceDir).filter(f => f.endsWith('.log'));
        for (const file of autopilotFiles) {
          const sourcePath = join(autopilotSourceDir, file);
          const targetPath = join(autopilotTargetDir, file);
          copyFileSync(sourcePath, targetPath);
          console.log(`Copied: ${file} (autopilot)`);
        }
      }
    } catch (error) {
      // Autopilot directory may not exist yet - that's OK
      console.log('Note: Autopilot logs directory not found (will be created when first command runs)');
    }

    // Sync BibleScholar exports
    mkdirSync(biblescholarTargetDir, { recursive: true });
    try {
      if (statSync(biblescholarSourceDir).isDirectory()) {
        const biblescholarFiles = readdirSync(biblescholarSourceDir).filter(f => f.endsWith('.json'));
        for (const file of biblescholarFiles) {
          const sourcePath = join(biblescholarSourceDir, file);
          const targetPath = join(biblescholarTargetDir, file);
          copyFileSync(sourcePath, targetPath);
          console.log(`Copied: ${file} (biblescholar)`);
        }
      }
    } catch (error) {
      // BibleScholar directory may not exist yet - that's OK
      console.log('Note: BibleScholar exports directory not found (run export scripts to generate)');
    }

    // Sync graph data files (graph_latest.json, graph_stats.json, etc.)
    try {
      if (statSync(graphSourceDir).isDirectory()) {
        const graphFiles = ['graph_latest.json', 'graph_stats.json', 'graph_patterns.json', 'temporal_patterns.json', 'pattern_forecast.json'];
        for (const file of graphFiles) {
          const sourcePath = join(graphSourceDir, file);
          const targetPath = join(graphTargetDir, file);
          try {
            if (statSync(sourcePath).isFile()) {
              copyFileSync(sourcePath, targetPath);
              console.log(`Copied: ${file} (graph)`);
            }
          } catch (err) {
            // File doesn't exist - that's OK, skip it
            console.log(`Note: ${file} not found in share/exports (run export scripts to generate)`);
          }
        }
      }
    } catch (error) {
      console.log('Note: Graph exports directory not found (run export scripts to generate)');
    }

  } catch (error) {
    console.error('Error syncing docs-control exports:', error.message);
    process.exit(1);
  }
}

syncFiles();

