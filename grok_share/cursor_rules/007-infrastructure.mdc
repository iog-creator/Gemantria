---
description: Infrastructure and checkpointer safety
globs:
  - src/infra/**/*
alwaysApply: false
---

- Checkpointer factory validates CHECKPOINTER env var; defaults to memory for unknown values.
- Postgres checkpointer requires GEMATRIA_DSN; raises clear error when missing.
- Memory checkpointer used for development/CI; Postgres available for production persistence.
- Infrastructure code must be fully tested with 100% coverage; placeholder implementations allowed but must raise NotImplementedError.
- Postgres checkpointer MUST implement full BaseCheckpointSaver interface (get_tuple, list, put, put_writes) with JSONB storage.
- Use transactional upsert (ON CONFLICT) with parameterized SQL (%s).
- No DDL in runtime code; migrations own schema.
- Coverage for infra code remains â‰¥98%.

# Rule: Metrics & Logging Must Be Wired
- All nodes must be registered via `with_metrics`.
- Builds fail if any node is added without metrics wrapper.
- Postgres metrics insert must be parameterized SQL (checked by grep).