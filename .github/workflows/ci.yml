name: CI
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ "**" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for --from-ref/--to-ref

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pre-commit ruff mypy pytest

      # Temporarily disabled - scoping not working correctly, runs on all files
      # Will be re-enabled after fixing scoping logic
      # - name: Run pre-commit (changed files only)
      #   uses: pre-commit/action@v3.0.1
      #   with:
      #     # Lint/type-check only files changed in this PR
      #     extra_args: --from-ref origin/${{ github.base_ref }} --to-ref ${{ github.sha }}

      # Temporarily disabled - pre-existing code quality issues
      # Will be re-enabled after codebase cleanup
      # - name: Lint & type
      #   run: |
      #     make py.lint || ruff check
      #     make py.type || mypy --config-file=mypy.ini --ignore-missing-imports src

      - name: Audits
        run: |
          make rules.navigator.check rules.audit repo.audit docs.audit

      - name: Smoke tests
        run: |
          make test.smoke
