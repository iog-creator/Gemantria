name: housekeeping-masterref (opt-in)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  masterref:
    if: ${{ vars.ENABLE_MASTERREF == '1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
      - name: Run masterref (STRICT)
        env:
          # Prefer RO on CI; fall back to RW only if RO not provided and policy allows.
          GEMATRIA_RO_DSN: ${{ secrets.GEMATRIA_RO_DSN }}
          GEMATRIA_DSN: ${{ secrets.GEMATRIA_DSN }}
          ATLAS_DSN_RO: ${{ secrets.ATLAS_DSN_RO }}
          STRICT_MASTER_REF: "1"
          GITHUB_REF_TYPE: "tag"
        run: make housekeeping.masterref

