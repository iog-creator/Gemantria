name: coverage-nightly
on:
  schedule:
    - cron: "31 7 * * *" # daily 07:31 UTC (after mypy/lint)
  workflow_dispatch: {}
  pull_request:
    branches: [ main, master, develop ]
permissions:
  contents: read
  actions: read

jobs:
  coverage-nightly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (project + pytest + coverage)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: Run coverage sweep (non-blocking)
        id: coverage
        continue-on-error: true
        run: |
          set -e
          mkdir -p share/eval/coverage
          # Run pytest coverage with multiple output formats
          pytest -q --maxfail=1 --disable-warnings \
            --cov=src --cov-report=term --cov-report=xml:share/eval/coverage/coverage.xml \
            --cov-report=html:share/eval/coverage/html || true
          # Extract coverage percentage and emit HINT
          PCT=$(python3 -c "import xml.etree.ElementTree as ET; t=ET.parse('share/eval/coverage/coverage.xml').getroot(); print(float(t.attrib.get('line-rate', '0')) * 100)" 2>/dev/null || echo "0")
          echo "HINT: coverage-nightly: percent=${PCT}"

      - name: Upload coverage report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage_report
          path: |
            share/eval/coverage/coverage.xml
            share/eval/coverage/html/

      - name: Summarize
        run: |
          if [ -f share/eval/coverage/coverage.xml ]; then
            echo "Coverage report generated and uploaded"
          else
            echo "Coverage report generation failed"
          fi
