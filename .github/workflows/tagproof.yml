name: tagproof

on:
  push:
    tags:
      - 'v*'
      - '*-rc*'

jobs:
  tagproof:
    runs-on: ubuntu-latest
    env:
      PIP_REQUIRE_VENV: 'true'         # hermetic; no pip installs
      ATLAS_DSN: ${{ vars.ATLAS_DSN }} # repository variable (masked by proof script)
      STRICT_WEBPROOF: "1"              # Rule-067: fail-closed on Atlas UI regressions
      # DSN STRICT env for release tags (aligns with pm-snapshot workflow)
      BIBLE_DB_DSN: ${{ secrets.BIBLE_DB_DSN }}
      GEMATRIA_DSN: ${{ secrets.GEMATRIA_DSN }}
      CHECKPOINTER: postgres
      ENFORCE_STRICT: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Require ATLAS_DSN for STRICT proof
        run: |
          if [ -z "${ATLAS_DSN:-}" ]; then
            echo "ERROR: vars.ATLAS_DSN is not set. Set it in repo variables (masked in outputs)."
            exit 1
          fi
      - name: Python version (system)
        run: python3 --version || true
      - name: Run ops.tagproof (STRICT)
        run: make -s ops.tagproof
      - name: Atlas webproof (STRICT, Rule-067)
        run: |
          STRICT_WEBPROOF=1 bash scripts/ci/atlas_webproof.sh
      - name: MCP Knowledge DB (STRICT)
        run: make guard.mcp.db.ro STRICT_DB_PROBE=1
      - name: Control-plane exports (STRICT)
        run: |
          make control.graph.compliance.export
          make control.biblescholar.reference.export
      - name: Control-plane guards (STRICT)
        run: |
          STRICT_MODE=1 make guard.control.graph.compliance --write-evidence guard_control_graph_compliance.json
          STRICT_MODE=1 make guard.biblescholar.reference --write-evidence guard_biblescholar_reference.json
          STRICT_MODE=1 make guard.control.widgets --write-evidence guard_control_widgets.json
      - name: Atlas compliance dashboards (STRICT)
        run: |
          make atlas.compliance.summary
          STRICT_MODE=1 make guard.atlas.compliance.summary
      - name: Show masked DSN proof JSON
        run: |
          test -f docs/evidence/atlas_proof_dsn.json && \
          sed -n '1,200p' docs/evidence/atlas_proof_dsn.json || true

