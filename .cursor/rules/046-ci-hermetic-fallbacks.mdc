---
description: Hermetic CI Fallbacks
alwaysApply: false
globs: []
---
# 046 â€” Hermetic CI Fallbacks (AlwaysApply)

## Context Scope
**THIS RULE APPLIES ONLY TO CI/HERMETIC CONTEXTS**, not live development or operations. For live development/operations, see Rule 062 (Environment Validation) which mandates auto-starting services.

- No outbound inference in CI; use deterministic mocks (e.g., `MOCK_AI=1`).
- Nightlies/observability steps emit HINTs and continue (non-blocking).
- **File Verification**: All file operations MUST verify existence first using explicit checks (`test -f`, `os.path.exists`, `head`) before reading/writing. Missing critical files emit LOUD FAIL per Rule-039 (no auto-creation, fail-closed).
- **DSN Handling - CRITICAL DISTINCTION (CI/HERMETIC ONLY)**:
  - **Operational commands that REQUIRE database** (ingestion, dashboard-refresh, data writes): MUST fail with exit code 1 when DB unavailable. These commands cannot function without the database.
  - **Observability/status commands** (health checks, status queries, exports that read existing data): MAY handle db_off gracefully (return empty results, emit HINTs, exit 0). **This graceful degradation applies ONLY in CI/hermetic contexts where services are intentionally offline.**
  - **Test/guard commands**: MAY handle db_off gracefully per their design (hermetic behavior).
  - DSN access must use centralized loaders (`scripts.config.env` preferred) - never direct `os.getenv("GEMATRIA_DSN")`.
- **When NOT to apply this rule**: In live development/operations contexts where services should be running, Rule 062 takes precedence and mandates auto-starting services rather than graceful degradation.
