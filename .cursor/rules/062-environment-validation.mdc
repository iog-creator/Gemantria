---
description: Environment validation and venv management (always-on)
alwaysApply: false
---

# Environment Validation (Always Required)

## Purpose
Prevent catastrophic failures by ensuring correct environment before any operations.

## Context Scope
**THIS RULE APPLIES TO LIVE DEVELOPMENT AND OPERATIONS CONTEXTS**, not CI/hermetic environments. For CI/hermetic contexts where services are intentionally offline, see Rule 046 (Hermetic CI Fallbacks) which allows graceful degradation.

## Critical Environment Checks (MANDATORY)

### 0. Service Status Check (FIRST STEP - BEFORE TROUBLESHOOTING)
**CRITICAL: BEFORE ANY TROUBLESHOOTING OR DEBUGGING**: Always check if required services are running.

**MANDATORY CHECK (use before troubleshooting any UI/API issues):**
```bash
# Use the service status script
bash scripts/check_services.sh

# Or use Makefile target
make services.check
```

**What it checks:**
1. Virtual environment (.venv) activation status
2. API server (port 8000) - required for `/api/*` endpoints
3. Vite dev server (port 5173) - required for UI dashboard
4. Database connection (optional, may be expected to be off in CI)

**If services are not running:**
- **DO NOT** troubleshoot UI/API issues until services are started
- **DO NOT** assume code is broken - check service status first
- **AUTOMATICALLY START** missing services before debugging (Cursor must do this, not wait for orchestrator)

**MANDATORY: Auto-Start Services When Down**
When services are detected as down, Cursor MUST automatically start them:
1. **Database (Postgres)**: Run `pmagent bringup full` which automatically detects and starts DB (systemd/brew/docker)
2. **LM Studio**: `pmagent bringup full` also starts LM Studio server
3. **API Server**: Start manually if needed: `python3 -m uvicorn src.services.api_server:app --host 0.0.0.0 --port 8000 --reload &`
4. **Vite Server**: Start manually if needed: `cd ui && npm run dev &`

**For tasks requiring live DB+LM (LIVE DEVELOPMENT/OPERATIONS ONLY):**
- If `make reality.green` fails due to `db_off` or `lm_off`, Cursor MUST run `pmagent bringup full` first
- Then re-run the task/check
- Do NOT report "DB offline" as expected behavior when task requires live services
- **Note**: In CI/hermetic contexts, Rule 046 allows graceful degradation. This auto-start mandate applies only when operating in live development/operations mode.

**Common Issues:**
- `.venv` not activated â†’ `source .venv/bin/activate`
- Database not running â†’ `pmagent bringup full` (auto-detects and starts)
- LM Studio not running â†’ `pmagent bringup full` (starts server)
- API server not running â†’ `python3 -m uvicorn src.services.api_server:app --host 0.0.0.0 --port 8000 --reload &`
- Vite server not running â†’ `cd ui && npm run dev &`

**Enforcement:**
- Rule 050 (OPS Contract) requires service status check as FIRST step before troubleshooting
- All troubleshooting sessions must start with `bash scripts/check_services.sh`
- Helper script: `scripts/check_services.sh` - use before any debugging

### 1. Virtual Environment Validation
**CRITICAL: BEFORE ANY PYTHON COMMAND OR SESSION START**: Always verify correct venv activation.

**MANDATORY CHECK (use at start of every session):**
```bash
# Use the helper script
bash scripts/check_venv.sh

# Or inline check:
if [ -z "${VIRTUAL_ENV:-}" ] || [ "${VIRTUAL_ENV}" != "/home/mccoy/Projects/Gemantria.v2/.venv" ]; then
  echo "ðŸš¨ ENVIRONMENT FAILURE ðŸš¨" >&2
  echo "Expected venv: /home/mccoy/Projects/Gemantria.v2/.venv" >&2
  echo "Current venv: ${VIRTUAL_ENV:-NOT SET}" >&2
  echo "Current python: $(which python3 2>/dev/null || echo 'NOT FOUND')" >&2
  echo "ACTION REQUIRED: source .venv/bin/activate" >&2
  echo "ðŸš¨ DO NOT PROCEED ðŸš¨" >&2
  exit 1
fi
```

**Verification commands:**
```bash
# Must show: /home/mccoy/Projects/Gemantria.v2/.venv/bin/python3
which python3

# Must show: /home/mccoy/Projects/Gemantria.v2/.venv
echo $VIRTUAL_ENV

# If not correct: source .venv/bin/activate
```

**LOUD FAILURE if not in correct venv:**
```
ðŸš¨ ENVIRONMENT FAILURE ðŸš¨
Expected venv: /home/mccoy/Projects/Gemantria.v2/.venv
Current venv: $VIRTUAL_ENV
Current python: $(which python3)
ACTION REQUIRED: source .venv/bin/activate
ðŸš¨ DO NOT PROCEED ðŸš¨
```

**Enforcement:**
- Rule 050 (OPS Contract) requires venv check as FIRST step in Evidence-First Protocol
- All Python scripts should include venv check at start (see `scripts/bringup_001.sh` for example)
- Helper script: `scripts/check_venv.sh` - use at session start or before Python commands

### 2. LM Studio Configuration Validation
**BEFORE ANY AI OPERATIONS**: Verify LM Studio connectivity:

```bash
export LM_STUDIO_HOST="http://127.0.0.1:9994"
export RERANKER_MODEL="qwen.qwen3-reranker-0.6b"
export THEOLOGY_MODEL="christian-bible-expert-v2.0-12b"
export EMBEDDING_MODEL="text-embedding-bge-m3"

# Test health check
python -c "from src.services.lmstudio_client import assert_qwen_live; result = assert_qwen_live(['christian-bible-expert-v2.0-12b']); print(f'Health: {result.ok} - {result.reason}')"
```

### 3. Database Configuration Validation
**BEFORE ANY DB OPERATIONS**: Verify database connections and AUTO-START if needed.

**IMPORTANT**: All DSN access must go through centralized loaders:
- **Preferred**: `scripts.config.env` (`get_rw_dsn()`, `get_ro_dsn()`, `get_bible_db_dsn()`)
- **Legacy**: `src.gemantria.dsn` (`dsn_rw()`, `dsn_ro()`, `dsn_atlas()`)
- **Never** use `os.getenv("GEMATRIA_DSN")` directly - enforced by `guard.dsn.centralized`

**AUTO-START DATABASE WHEN DOWN (LIVE DEVELOPMENT/OPERATIONS ONLY):**
If database is detected as offline and task requires live DB **in a live development/operations context** (not CI/hermetic):
1. Run `pmagent bringup full` - automatically detects DB environment (systemd/brew/docker) and starts it
2. Wait 2-3 seconds for Postgres to fully start
3. Re-check connection: `pg_isready` or `pmagent health db`
4. Proceed with task
- **CI/Hermetic Context**: In CI/hermetic environments where services are intentionally offline, Rule 046 applies and graceful degradation is acceptable. This auto-start requirement does NOT apply in CI/hermetic contexts.

```bash
# Check if DSNs are set (via centralized loader)
python3 -c "from scripts.config.env import get_rw_dsn, get_ro_dsn, get_bible_db_dsn; print(f'RW: {get_rw_dsn() is not None}'); print(f'RO: {get_ro_dsn() is not None}'); print(f'Bible: {get_bible_db_dsn() is not None}')"

# If database is down and task requires it, AUTO-START:
pmagent bringup full  # Starts DB + LM Studio automatically

# If not set, use defaults from env_example.txt
export GEMATRIA_DSN="postgresql://mccoy@/gematria?host=/var/run/postgresql"
export BIBLE_DB_DSN="postgresql://postgres@/bible_db?host=/var/run/postgresql"
```

## Environment Persistence Requirements

### 1. Automatic Environment Loading
All scripts and commands MUST load environment automatically:

```bash
# Every script must start with:
source activate_venv.sh
export LM_STUDIO_HOST="http://127.0.0.1:9994"
export RERANKER_MODEL="qwen.qwen3-reranker-0.6b"
export THEOLOGY_MODEL="christian-bible-expert-v2.0-12b"
export EMBEDDING_MODEL="text-embedding-bge-m3"
```

### 2. Environment State Preservation
**MANDATORY**: Preserve environment state across sessions:

- Store environment variables in `.env` file
- Include environment validation in all Makefiles
- Add environment checks to CI/CD pipelines

## Failure Protocol

### If Environment Check Fails:
1. **STOP ALL OPERATIONS IMMEDIATELY**
2. **EMIT LOUD FAILURE MESSAGE**
3. **WAIT FOR USER APPROVAL** before proceeding
4. **DOCUMENT THE FAILURE** for future prevention

### Environment Recovery Commands:
```bash
# Complete environment reset
source activate_venv.sh
export LM_STUDIO_HOST="http://127.0.0.1:9994"
export RERANKER_MODEL="qwen.qwen3-reranker-0.6b"
export THEOLOGY_MODEL="christian-bible-expert-v2.0-12b"
export EMBEDDING_MODEL="text-embedding-bge-m3"

# Validate everything works
python -c "import psycopg; from src.services import lmstudio_client; print('âœ… Environment ready')"
```

## Related Rules
- **Rule 011**: Production Safety (Qwen Live Gate)
- **Rule 046**: Hermetic CI Fallbacks
- **Rule 063**: Git Safety (no destructive operations)

## Mandatory Cross-References
- **AGENTS.md**: Environment setup section
- **env_example.txt**: Complete environment configuration
- **activate_venv.sh**: Virtual environment activation script