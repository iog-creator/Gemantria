---
description: Mandatory run `make housekeeping` after every change/PR. Fail-closed if skipped—critical error log/CI fail. Includes share.sync, governance, ADRs, rules audit, forest regen, and evidence archiving.
globs:
  - "src/**"
  - "scripts/**"
  - "migrations/**"
  - "webui/**"
  - "docs/**"
  - "AGENTS.md"
  - ".cursor/rules/**"
alwaysApply: false
---

**CRITICAL CURSOR ENFORCEMENT**: After ANY file edit in this repository, Cursor MUST automatically run `make housekeeping` before committing. This is non-negotiable. Do not proceed without running housekeeping.

**AUTOMATIC DOCUMENTATION UPDATES**: The housekeeping pipeline now **automatically** updates:
- **AGENTS.md files** — Detected from code changes (new functions, classes, components)
- **CHANGELOG.md** — Extracted from commit messages (feat/fix/docs entries)

**You should NOT need to manually update these files** — they are updated automatically by `scripts/auto_update_agents_md.py` and `scripts/auto_update_changelog.py` as part of `make housekeeping`. If you find yourself manually editing AGENTS.md or CHANGELOG.md, that indicates the auto-update scripts need enhancement, not that manual updates are required.

# Rule 058 — Auto-Housekeeping Post-Change (AlwaysApply)

Mandatory run `make housekeeping` after every change/PR. Fail-closed if skipped—critical error log/CI fail.

## Requirements

**MANDATORY EXECUTION**: After ANY codebase change (code/docs/rules), developers MUST run:

```bash
# Unified housekeeping command (runs all steps)
make housekeeping
```

The `make housekeeping` target executes:
1. **Share synchronization** (`make share.sync`) — mirrors docs/scripts/rules to `share/`
2. **ADR housekeeping** (`adr.housekeeping`) — ADR validation and updates
3. **Governance housekeeping** (`governance.housekeeping`) — runs `scripts/governance_housekeeping.py` for database compliance + docs
4. **Governance docs hints** (`governance.docs.hints`) — emits hints for rule/docs changes (Rule-026)
5. **Document management hints** (`docs.hints`) — populates document operation metrics (Rule-061)
6. **Document master reference** (`docs.masterref.populate`) — populates document_sections table for analytics
7. **AGENTS.md auto-update** (`python3 scripts/auto_update_agents_md.py`) — **AUTOMATICALLY** updates AGENTS.md files based on code changes (Rule-058)
8. **CHANGELOG.md auto-update** (`python3 scripts/auto_update_changelog.py`) — **AUTOMATICALLY** updates CHANGELOG.md based on recent commits (Rule-058)
9. **AGENTS.md validation** (`python3 scripts/validate_agents_md.py`) — ensures all subdirectory AGENTS.md files exist and are valid
10. **Rules audit** (`python3 scripts/rules_audit.py`) — validates rule compliance
11. **Forest generation** (`python3 scripts/generate_forest.py`) — regenerates forest overview
12. **Handoff update** (`handoff.update`) — regenerates `NEXT_STEPS.md` via `scripts/generate_handoff.py`
13. **PM snapshot** (`pm.snapshot`) — generates PM-facing status snapshot

**Individual commands** (if needed separately):
```bash
make share.sync                              # Documentation synchronization
python3 scripts/auto_update_agents_md.py     # Auto-update AGENTS.md files (Rule-058)
python3 scripts/auto_update_changelog.py     # Auto-update CHANGELOG.md (Rule-058)
python3 scripts/validate_agents_md.py        # Validate AGENTS.md presence/structure
python3 scripts/governance_housekeeping.py   # Governance compliance
python3 scripts/generate_handoff.py          # Handoff document
python3 scripts/rules_audit.py               # Rule compliance audit
python3 scripts/generate_forest.py           # Forest overview regeneration
```

**FAIL-CLOSED DESIGN**: If housekeeping skipped, operations fail with critical error logs:
```
CRITICAL: Housekeeping not run after changes - failing per Rule 058
Evidence: Modified files detected without housekeeping completion
```

## Integration Points

### CI/CD Enforcement
- **Pre-commit hooks**: Block commits without housekeeping completion
- **PR checks**: Require housekeeping evidence in PR descriptions  
- **Branch protection**: Enforce housekeeping completion for merges

### Development Workflow
- **IDE integration**: Automatic housekeeping prompts after saves
- **Git hooks**: Pre-commit validation of housekeeping status
- **Status indicators**: Clear visual feedback on housekeeping state

## Additional Housekeeping Contexts

### Evidence Archiving
- **Evidence bundles**: Archive workflow logs, guard results, and validation proofs in `share/evidence/`
- **RFC3339 fast-lane**: Evidence archived at `share/evidence/rfc3339-fastlane/<timestamp>/`
- **Guard evidence**: Guard runs generate evidence files in `share/evidence/guard_all_*.json`

### Guard Validation
- **Export validation**: Run `make guard.tests` to validate RFC3339 timestamps and metadata
- **Comprehensive guards**: Run `STRICT_RFC3339=0 make guards.all` for full validation suite
- **Guard evidence**: Guard runs automatically generate evidence files for audit

### Documentation Updates (AUTOMATIC)
- **AGENTS.md files**: **AUTOMATICALLY** updated by `scripts/auto_update_agents_md.py` when code changes are detected
  - Detects new functions, classes, components in changed files
  - Updates relevant AGENTS.md files with timestamp refresh
  - Creates missing AGENTS.md files with basic template
  - **No manual intervention required** — runs as part of `make housekeeping`
- **CHANGELOG.md**: **AUTOMATICALLY** updated by `scripts/auto_update_changelog.py` based on recent commits
  - Extracts feature/fix/docs entries from conventional commit messages
  - Detects Phase-3B Feature #X patterns and PR numbers
  - Adds entries to [Unreleased] section
  - **No manual intervention required** — runs as part of `make housekeeping`
- **ADR creation**: New ADRs must be added to `docs/adr/` and cross-referenced (manual)
- **RELEASES.md**: Update with version entries for significant changes (manual)
- **SHARE_MANIFEST.json**: Link evidence bundles and new artifacts (manual)

### Working Tree Reconciliation
- **Generator drift**: Run `make guard.tests` and `make share.sync` to fix export/share drift
- **Untracked files**: Review and commit evidence files or add to `.gitignore`
- **Tracked changes**: Commit intentional changes via hygiene PRs

## Related Rules

- **Rule 027**: Docs sync gate (housekeeping includes docs sync)
- **Rule 030**: Share sync (mandatory after docs/scripts/rules changes)
- **Rule 055**: Auto-docs sync pass (housekeeping enforces this)
- **Rule 017**: Agent docs presence (housekeeping validates coverage)
- **Rule 051**: Cursor insight (evidence-first workflow)
- **Rule 061**: AI learning tracking (hint envelope detection)