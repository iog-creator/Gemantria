# On-Demand Handoff Generation System Design

**Status:** Design Document  
**Purpose:** Replace brittle manual doc syncing with reliable on-demand handoff generation from Postgres/DMS  
**Related:** PM Contract Rule 6.9 (Backtracking Clarity), Rule 6.6 (Live Test Requirement)

---

## Problem Statement

The current system has critical gaps:

1. **Manual doc syncing is brittle**: `SHARE_MANIFEST.json` gets out of sync, files in `share/` become stale
2. **No reliable handoff generation**: `make housekeeping` doesn't generate PM handoff reports
3. **Static files don't reflect current state**: Docs in `share/` are snapshots, not live views
4. **No task-specific summaries**: All AIs get the same docs, regardless of their role or task

## Solution Architecture

### Core Principle: **Postgres/DMS as Single Source of Truth**

Generate handoff docs **on-demand** from Postgres data, not from static file syncing.

### Data Sources (Postgres/DMS)

1. **`control.agent_run`** - LM calls, tool executions
   - Fields: `tool`, `args_json`, `result_json`, `violations_json`, `created_at`
   - Use: Recent work activity, what was done, what failed

2. **`control.agent_run_cli`** - CLI command executions
   - Fields: `command`, `request_json`, `response_json`, `status`, `created_at`
   - Use: PM commands executed, their results, errors

3. **`control.doc_registry`** - Documentation registry
   - Fields: `logical_name`, `repo_path`, `share_path`, `is_ssot`, `updated_at`
   - Use: What docs exist, their sync status

4. **`control.kb_document`** - Knowledge base documents
   - Fields: `logical_name`, `content_hash`, `subsystem`, `updated_at`
   - Use: KB coverage, documentation gaps

5. **`evidence/pmagent/completion-*.json`** - Completion envelopes
   - Use: Work completion status, verification results, next steps

6. **`evidence/pmagent/capability_session-*.json`** - Capability session envelopes
   - Use: Current work context, posture, reality check results

### Handoff Document Types

#### 1. **Session Summary** (`share/handoff/session-{timestamp}.md`)
   - **Purpose**: End-of-chat summary for PM handoff
   - **Content**:
     - Recent work completed (from completion envelopes)
     - Recent agent_run activity (last 24h)
     - Current system state (reality check, status)
     - Next steps (from NEXT_STEPS.md or MASTER_PLAN.md)
     - Blockers/issues (from violations, errors)
   - **Generated by**: `pmagent handoff generate --type=session`

#### 2. **Task Context** (`share/handoff/task-{task_id}.md`)
   - **Purpose**: Task-specific context for any AI role
   - **Content**:
     - Task description (from capability_session or NEXT_STEPS)
     - Relevant recent work (filtered by task)
     - Required context (docs, schemas, contracts)
     - Dependencies (what must be done first)
     - Acceptance criteria
   - **Generated by**: `pmagent handoff generate --type=task --task-id={id}`

#### 3. **Role Primer** (`share/handoff/role-{role}.md`)
   - **Purpose**: Role-specific guidance for starting a new chat
   - **Roles**: `cursor`, `pm`, `granite`, `orchestrator`
   - **Content**:
     - Role-specific contracts (PM_CONTRACT.md for PM, AGENTS.md for Cursor)
     - Current active workstreams
     - Recent decisions/changes
     - Common pitfalls for this role
   - **Generated by**: `pmagent handoff generate --type=role --role={role}`

#### 4. **System State** (`share/handoff/system-state.json`)
   - **Purpose**: Machine-readable system state snapshot
   - **Content**:
     - DB health (from reality check)
     - LM health (from lm_indicator.json)
     - Recent activity summary (agent_run counts, top tools)
     - Documentation sync status (from doc_registry)
     - Governance compliance (from violations)
   - **Generated by**: `pmagent handoff generate --type=system-state`

### Implementation

#### Module: `agentpm/handoff/generator.py`

```python
def generate_session_handoff(
    *,
    hours: int = 24,
    include_envelopes: bool = True,
    include_agent_runs: bool = True,
) -> dict[str, Any]:
    """
    Generate session summary handoff document.
    
    Queries:
    - Recent completion envelopes (evidence/pmagent/completion-*.json)
    - Recent agent_run records (last N hours)
    - Current reality check status
    - Next steps from NEXT_STEPS.md
    """
    pass

def generate_task_handoff(
    task_id: str,
    *,
    include_context: bool = True,
    include_dependencies: bool = True,
) -> dict[str, Any]:
    """
    Generate task-specific handoff document.
    
    Queries:
    - Capability session envelope for task_id
    - Related agent_run records (filtered by task context)
    - Required documentation (from doc_registry)
    - Dependencies (from MASTER_PLAN.md or NEXT_STEPS.md)
    """
    pass

def generate_role_primer(
    role: str,
    *,
    include_contracts: bool = True,
    include_active_work: bool = True,
) -> dict[str, Any]:
    """
    Generate role-specific primer document.
    
    Queries:
    - Role-specific contracts (PM_CONTRACT.md, AGENTS.md, etc.)
    - Active workstreams (from MASTER_PLAN.md)
    - Recent decisions (from agent_run_cli with command="plan.*")
    - Common issues (from violations, errors)
    """
    pass

def generate_system_state() -> dict[str, Any]:
    """
    Generate machine-readable system state snapshot.
    
    Queries:
    - Reality check results (via pmagent reality-check check)
    - LM health (from lm_indicator.json or control.agent_run)
    - Agent run statistics (counts, top tools, error rates)
    - Documentation sync status (from doc_registry)
    """
    pass
```

#### CLI Command: `pmagent handoff generate`

```bash
# Generate session summary (default)
pmagent handoff generate

# Generate task-specific handoff
pmagent handoff generate --type=task --task-id="NEXT_STEPS:1"

# Generate role primer
pmagent handoff generate --type=role --role=cursor

# Generate system state (JSON)
pmagent handoff generate --type=system-state --format=json

# Custom time window
pmagent handoff generate --hours=48
```

### Integration Points

1. **AWCG Integration**: After `make work.complete`, auto-generate session handoff
2. **Reality Loop Integration**: After `pmagent plan reality-loop`, generate task handoff
3. **Chat Handoff**: Before ending chat, generate session handoff for next AI
4. **Role Switching**: When switching AI roles, generate role primer

### File Naming Convention

- `share/handoff/session-{RFC3339-timestamp}.md`
- `share/handoff/task-{task_id}-{RFC3339-timestamp}.md`
- `share/handoff/role-{role}-{RFC3339-timestamp}.md`
- `share/handoff/system-state-{RFC3339-timestamp}.json`

### Markdown Template Structure

```markdown
# {Title}

**Generated:** {RFC3339 timestamp}  
**Type:** {session|task|role|system-state}  
**Source:** Postgres/DMS (on-demand)

## Recent Work

{Summary of completion envelopes and agent_run activity}

## Current State

{Reality check, status, health indicators}

## Next Steps

{From NEXT_STEPS.md or MASTER_PLAN.md}

## Blockers/Issues

{From violations, errors, failed agent_runs}

## Context

{Relevant docs, schemas, contracts}
```

### Benefits

1. **Always Current**: Generated on-demand from live Postgres data
2. **Task-Specific**: Filtered by task context, not one-size-fits-all
3. **Role-Aware**: Different summaries for different AI roles
4. **Reliable**: No manual syncing, no stale files
5. **Traceable**: All data comes from auditable Postgres tables

### Migration Path

1. **Phase 1**: Implement `generate_session_handoff()` (highest priority)
2. **Phase 2**: Implement `generate_task_handoff()` and `generate_role_primer()`
3. **Phase 3**: Implement `generate_system_state()` (JSON format)
4. **Phase 4**: Integrate with AWCG and reality loop
5. **Phase 5**: Deprecate `SHARE_MANIFEST.json` manual syncing (keep as fallback)

---

## Acceptance Criteria

- [ ] `pmagent handoff generate` generates session summary from Postgres data
- [ ] Handoff docs are written to `share/handoff/` with RFC3339 timestamps
- [ ] Session summaries include recent work, current state, next steps
- [ ] Task handoffs are filtered by task context
- [ ] Role primers include role-specific contracts and active work
- [ ] System state is machine-readable JSON
- [ ] All queries use Postgres/DMS as source of truth
- [ ] No manual file syncing required
- [ ] Integration with AWCG auto-generates handoff after work completion

