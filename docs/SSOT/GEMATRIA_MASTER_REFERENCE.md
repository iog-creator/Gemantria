# Gemantria Master Reference – Version 2.0 (2025-11-10)

## Table of Contents
1. Overview
2. Architecture
3. Orchestration and Workflow
4. Single Source of Truth (SSOT) Contracts
5. Agent-Database Interface Design
6. Traceability and Evidence
7. Testing and UI Verification
8. Documentation and Maintainability
9. Appendix: Schema and Pipeline Summary

---

## 1. Overview
Gemantria is a deterministic, schema-first AI pipeline that transforms sacred text into structured graph insights via a hybrid of LLM agents, deterministic operators, and database integrations. Version 2.0 deepens our SSOT enforcement, improves traceability, and enhances orchestration with modern AI pipeline patterns.

## 2. Architecture
- **Modular, Node-Based DAG**: Built on LangGraph with stateful branches, retries, and fail-closed guards.
- **Hybrid AI + DB**: LLMs perform semantic enrichment; DB-backed functions handle verse search, gematria lookup, and storage.
- **Strict Outputs**: Every node emits JSON conforming to a registered versioned schema.
- **Orchestrator Wrapping**: LangGraph nodes optionally embedded within Prefect/Dagster for durability and UI traceability.
- **Prompt Logging and Replay**: Prompts and raw outputs stored alongside each stage.

### Diagram
```
[Ingest] → [Extract Nouns] → [Enrich Nouns] → [Build Graph] → [Score Graph] → [Write DB]
```

## 3. Orchestration and Workflow
- **Primary Orchestrator**: LangGraph governs agent flow.
- **Scheduling Layer**: Prefect recommended for scheduling, retries, and centralized run logging.
- **Durability Option**: Temporal optionally wraps pipeline for long-running stateful guarantees.
- **Asset-Aware Mode**: Dagster may be used for lineage tracking and asset-based execution.

### LangGraph Patterns Checklist
- [x] Named nodes
- [x] Checkpointer enabled
- [x] Guardrails at node boundary
- [x] Schema validation immediately after each node
- [x] Fail-fast if node prerequisites are not met

## 4. Single Source of Truth (SSOT) Contracts
- **Schemas**: All JSON artifacts validated against `ai-nouns.schema.json`, `graph.schema.json`, etc.
- **Pydantic Integration**: Models defined per schema, used for runtime checks and validation logs.
- **Version Enforcement**: Schema version bumps required on incompatible changes.
- **Drift Guard**: PRs fail if schema changed but no ADR/version bump.
- **Cross-schema Join Test**: JSON output must match DB table schema for inserted rows.
- **Doc Generation**: Run `make schema.docs` to regenerate reference tables and link to docs.

## 5. Agent-Database Interface Design
- **Function Tooling Only**: LLMs invoke tool-bound queries; no freeform SQL.
- **Tool Contracts**: Each tool defines I/O spec, validated via Pydantic.
- **Context Protocol Layer (MCP)**: Optional abstraction exposing structured DB endpoints for AI.
- **Multistage Delegation**: Specialized agents (semantic, theological, score) called via orchestrator or supervisor agent.
- **Audit Trails for Tool Use**: Each DB query includes param/result snapshot in logs.
- **Services Layer Isolation**: Agents call services, not SQL directly; allows mocking, caching.

## 6. Traceability and Evidence
- **Evidence Markdown**: Each edge/noun emits `evidence/<entity>.md` with reason, verses, source.
- **Prompt Logging**: Prompts + responses stored in `logs/run_<timestamp>.jsonl` with trace IDs.
- **Run Summary Report**: `report.md` includes extracted count, edge types, anomalies, and pass/fail guards.
- **Playwright-Indexed Screenshots**: Snapshot of final graph and per-node HTMLs stored for compliance.
- **Audit UI Artifacts**: All interactive outputs must have `analysis`, `source_refs`, and `evidence` fields populated or stubbed.

## 7. Testing and UI Verification
- **Browser Click Test**: Playwright script simulates node/edge interaction, screenshot captured.
- **Regression Snapshots**: Visual diff of key views (node hover, edge click, stats overlay).
- **DOM Consistency Check**: Node count in DOM must match JSON artifact.
- **UI Schema Tests**: Validate UI fields (e.g. `weight`, `theme`) exist and are present in all payloads.
- **CI Integration**: Frontend spun up in CI, tests run via `make ui.test` with error log capture.

## 8. Documentation and Maintainability
- **Auto Schema Docs**: `make schema.docs` → generates `docs/schemas/*.md` from JSON Schema.
- **Agent Manifest**: Generated by script from agent registry or `AGENTS.md` entries.
- **Prompt Archive**: Snapshotted prompts (via decorators or LangGraph callbacks) stored in `prompts/`.
- **ADRs and Changelogs Required**: Schema and behavior changes require entry in `RELEASES.md` and `docs/decisions/`.
- **MkDocs Compatible**: All Markdown content structured to support static site hosting if needed.

## 9. Appendix: Schema and Pipeline Summary
### Core Schemas

All schemas are documented in `docs/schemas/` (generated via `make schema.docs`):

- **[AI Nouns Schema](./schemas/SSOT_ai-nouns.v1.schema.md)** (`SSOT_ai-nouns.v1.schema.json`) – Noun ID, lemma, surface, gematria, references, etc.
- **[Graph Schema](./schemas/SSOT_graph.v1.schema.md)** (`SSOT_graph.v1.schema.json`) – Nodes, edges, relation types, evidence link
- **[Graph Stats Schema](./schemas/graph-stats.schema.md)** (`graph-stats.schema.json`) – Edge count, centrality, clustering
- **[Graph Patterns Schema](./schemas/graph-patterns.schema.md)** (`graph-patterns.schema.json`) – Pattern analysis and community detection
- **[Temporal Patterns Schema](./schemas/temporal-patterns.schema.md)** (`temporal-patterns.schema.json`) – Time-series pattern analysis
- **[Pattern Forecast Schema](./schemas/pattern-forecast.schema.md)** (`pattern-forecast.schema.json`) – Forecasting model outputs
- **[Graph Correlations Schema](./schemas/graph-correlations.schema.md)** (`graph-correlations.schema.json`) – Cross-text pattern analytics

**View full schema documentation**: [docs/schemas/](./schemas/)

### Pipeline Nodes
| Node           | Input               | Output             | Notes                         |
|----------------|----------------------|---------------------|-------------------------------|
| `ai.ingest`    | Source text DB       | Internal memory     | No external artifact          |
| `ai.nouns`     | Text                 | `ai_nouns.json`     | Validated post-extraction     |
| `ai.enrich`    | Noun list            | `ai_nouns.json`     | Adds `cross_refs`, `themes`   |
| `graph.build`  | Enriched nouns       | `graph.json`        | Links via semantics/theology  |
| `graph.score`  | Graph                | `graph_stats.json`  | Scores, clusters              |
| `db.write`     | Graph/nouns/stats    | Database rows       | Strict schema-to-table match  |
