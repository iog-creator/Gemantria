---
originating_ADR: DM-002
canonical: true
version: 1.0
---

# SSOT: Doc Control Panel Data Contract

## Overview

This document defines the contract between the Document Management System (DMS) backend and the Doc Control Panel frontend. The Doc Control Panel is an orchestrator-facing dashboard for managing document classification, canonical status, and archive planning.

This serves as the single source of truth for:
- JSON export file locations and formats
- Data shape expectations for the frontend
- Mapping between `control.kb_document` database fields and UI display fields
- Refresh command specification

## Data Refresh Command

All JSON exports are generated by a single command:

```bash
pmagent docs dashboard-refresh
```

This command:
- Reads from `control.kb_document` (read-only)
- Generates all 6 JSON export files in `share/exports/docs-control/`
- Updates timestamps in metadata
- Does not modify the database or move files

**Refresh Frequency**: Manual (operator-driven). Future phases may add scheduled refresh or real-time API.

## File Locations and Formats

All JSON exports are stored in `share/exports/docs-control/`:

### 1. Summary Data

- **File**: `share/exports/docs-control/summary.json`
- **Purpose**: Top-level dashboard metrics ("State at a glance")
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: Aggregated counts from `control.kb_document`

### 2. Canonical Documents List

- **File**: `share/exports/docs-control/canonical.json`
- **Purpose**: Complete list of canonical documents for the "Canonical" tab
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: `control.kb_document` where `is_canonical = TRUE`

### 3. Archive Candidates (Grouped)

- **File**: `share/exports/docs-control/archive-candidates.json`
- **Purpose**: Archive candidates grouped by directory for the "Archive Candidates" tab
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: `control.kb_document` where `status = 'archive_candidate'`

### 4. Unreviewed Documents Batch

- **File**: `share/exports/docs-control/unreviewed-batch.json`
- **Purpose**: Small batch of unreviewed documents for triage ("Unreviewed (Triage)" tab)
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: `control.kb_document` where `status = 'unreviewed'` (first 20 by default)

### 5. Orphans and Backups

- **File**: `share/exports/docs-control/orphans.json`
- **Purpose**: Orphan files and backup bundles for the "Orphans & Backups" tab
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: Parsed `docs/analysis/ORPHANS_CANDIDATE_REPORT.md` and file system scan

### 6. Archive Dry-Run Plan

- **File**: `share/exports/docs-control/archive-dryrun.json`
- **Purpose**: Concrete archive move plan from dry-run planner
- **Update Frequency**: On `pmagent docs dashboard-refresh`
- **Source**: Parsed `docs/analysis/DOC_ARCHIVE_DRYRUN.md` or direct DB query

## JSON Schema Definitions

### 1. Summary Data (`summary.json`)

```json
{
  "totals": {
    "canonical": 177,
    "archive_candidates": 690,
    "unreviewed": 1311,
    "total": 2178
  },
  "path_buckets": {
    "ssot": 35,
    "archive": 1695,
    "other": 448
  },
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `totals.canonical`: `COUNT(*) WHERE is_canonical = TRUE`
- `totals.archive_candidates`: `COUNT(*) WHERE status = 'archive_candidate'`
- `totals.unreviewed`: `COUNT(*) WHERE status = 'unreviewed'`
- `totals.total`: `COUNT(*)` (all documents)
- `path_buckets.ssot`: `COUNT(*) WHERE path LIKE 'docs/SSOT/%'`
- `path_buckets.archive`: `COUNT(*) WHERE path LIKE 'archive/%'`
- `path_buckets.other`: `COUNT(*) WHERE path NOT LIKE 'docs/SSOT/%' AND path NOT LIKE 'archive/%'`
- `generated_at`: RFC3339 timestamp of export generation

### 2. Canonical Documents (`canonical.json`)

```json
{
  "items": [
    {
      "path": "docs/SSOT/PM_CONTRACT_STRICT_SSOT_DMS.md",
      "title": "PM Contract — Strict SSOT / DMS",
      "doc_type": "ssot_contract",
      "status": "canonical",
      "is_canonical": true,
      "last_modified": "2025-11-15T12:34:56Z",
      "size_bytes": 12345
    }
  ],
  "total": 177,
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `path`: `control.kb_document.path` (repo-relative)
- `title`: `control.kb_document.title` (first heading or derived)
- `doc_type`: `control.kb_document.doc_type` (ssot | reference | runbook | legacy | unknown)
- `status`: `control.kb_document.status` (should be 'canonical' for these items)
- `is_canonical`: `control.kb_document.is_canonical` (always `true` for this export)
- `last_modified`: `control.kb_document.mtime` (RFC3339 format)
- `size_bytes`: `control.kb_document.size_bytes`
- `total`: Total count of canonical documents
- `generated_at`: RFC3339 timestamp of export generation

**Filtering Support** (future Phase 2):
- Query params: `path_prefix`, `q` (search), `limit`, `offset`
- For Phase 1, frontend filters client-side on the full `items` array

### 3. Archive Candidates (Grouped) (`archive-candidates.json`)

```json
{
  "groups": [
    {
      "directory": "archive/evidence_v0.0.9_pre/",
      "count": 650,
      "example_paths": [
        "archive/evidence_v0.0.9_pre/branch.before.txt",
        "archive/evidence_v0.0.9_pre/a_exporter.head.txt"
      ],
      "confidence": "safe_cluster",
      "notes": "All status=archive_candidate under known evidence snapshot."
    }
  ],
  "total_groups": 12,
  "total_items": 690,
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `groups[].directory`: Common directory prefix (e.g., `archive/evidence_v0.0.9_pre/`)
- `groups[].count`: Number of archive_candidate docs in this directory
- `groups[].example_paths`: Up to 3 example file paths from this group
- `groups[].confidence`: `"safe_cluster"` | `"mixed_cluster"` (heuristic-based)
  - `safe_cluster`: All items in directory are archive_candidate and directory is clearly archival
  - `mixed_cluster`: Some items might still matter (mixed statuses or ambiguous paths)
- `groups[].notes`: Human-readable explanation of confidence level
- `total_groups`: Number of directory groups
- `total_items`: Total count of archive_candidate documents
- `generated_at`: RFC3339 timestamp of export generation

**Grouping Logic**:
- Group by longest common directory prefix (at least 2 path segments)
- Groups with < 3 items are merged into "other" category
- Confidence is determined by:
  - All items have `status = 'archive_candidate'` → `safe_cluster`
  - Directory is under `archive/` or contains "evidence", "backup", "old" → `safe_cluster`
  - Otherwise → `mixed_cluster`

### 4. Unreviewed Documents Batch (`unreviewed-batch.json`)

```json
{
  "batch_id": "2025-11-19T08:01:00Z-1",
  "items": [
    {
      "path": "docs/notes/random_experiment.md",
      "doc_type": "note",
      "status": "unreviewed",
      "title": "Random Experiment Notes",
      "snippet": "Quick scratch notes from 2024-12-05...",
      "guess": "experiment_notes",
      "last_modified": "2024-12-05T10:20:30Z"
    }
  ],
  "batch_size": 20,
  "remaining_estimate": 1291,
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `batch_id`: Unique identifier for this batch (timestamp-based)
- `items[].path`: `control.kb_document.path`
- `items[].doc_type`: `control.kb_document.doc_type`
- `items[].status`: `control.kb_document.status` (should be 'unreviewed')
- `items[].title`: `control.kb_document.title`
- `items[].snippet`: First 200 characters of file content (for preview)
- `items[].guess`: Heuristic guess at document purpose (e.g., "experiment_notes", "old_doc", "backup")
- `items[].last_modified`: `control.kb_document.mtime` (RFC3339)
- `batch_size`: Number of items in this batch (default: 20)
- `remaining_estimate`: Estimated remaining unreviewed docs (`total_unreviewed - batch_size`)
- `generated_at`: RFC3339 timestamp of export generation

**Batch Selection**:
- Selects first `batch_size` unreviewed documents ordered by `mtime DESC` (newest first)
- Future Phase 2: Support pagination with `batch_id` and `offset`

### 5. Orphans and Backups (`orphans.json`)

```json
{
  "categories": [
    {
      "name": "backup_bundles",
      "description": "Top-level backup bundles not referenced anywhere.",
      "items": [
        {
          "path": "backup-safety-rules-2024-11-01.tar.gz",
          "type": "file",
          "size_bytes": 1048576
        },
        {
          "path": "backups/",
          "type": "directory",
          "item_count": 15
        }
      ]
    },
    {
      "name": "evidence_snapshots",
      "description": "Historical evidence directories.",
      "items": [
        {
          "path": "archive/evidence_v0.0.9_pre/",
          "type": "directory",
          "item_count": 650
        }
      ]
    }
  ],
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `categories[].name`: Category identifier (`backup_bundles`, `evidence_snapshots`, `stray_files`, `stray_dirs`)
- `categories[].description`: Human-readable description of category
- `categories[].items[].path`: File or directory path (repo-relative)
- `categories[].items[].type`: `"file"` | `"directory"`
- `categories[].items[].size_bytes`: File size (for files only)
- `categories[].items[].item_count`: Number of items in directory (for directories only)
- `generated_at`: RFC3339 timestamp of export generation

**Source**:
- Parsed from `docs/analysis/ORPHANS_CANDIDATE_REPORT.md`
- Or direct file system scan using `scripts/dev/list_orphans.py` logic

### 6. Archive Dry-Run Plan (`archive-dryrun.json`)

```json
{
  "total_candidates": 689,
  "items": [
    {
      "from": "archive/evidence_v0.0.9_pre/a_exporter.head.txt",
      "to": "archive/docs/evidence_v0.0.9_pre/a_exporter.head.txt",
      "reason": "status=archive_candidate",
      "size_bytes": 1024
    }
  ],
  "groups": [
    {
      "directory": "archive/evidence_v0.0.9_pre/",
      "count": 650,
      "total_size_bytes": 1048576
    }
  ],
  "generated_at": "2025-11-19T08:00:00Z"
}
```

**Field Mappings**:
- `total_candidates`: Total number of files in the dry-run plan
- `items[].from`: Current file path (repo-relative)
- `items[].to`: Proposed archive destination path (under `archive/docs/...`)
- `items[].reason`: Reason for archiving (e.g., `"status=archive_candidate"`, `"duplicate"`, `"orphan"`)
- `items[].size_bytes`: File size in bytes
- `groups[].directory`: Directory grouping for summary
- `groups[].count`: Number of files in this directory group
- `groups[].total_size_bytes`: Total size of files in this group
- `generated_at`: RFC3339 timestamp of export generation

**Source**:
- Parsed from `docs/analysis/DOC_ARCHIVE_DRYRUN.md`
- Or direct query from `control.kb_document` where `status = 'archive_candidate'` with archive path heuristics

**Note**: This is a **dry-run plan only**. No files are moved. Future Phase 2 may add an `archive-apply` command that executes these moves with receipts.

## TypeScript Interfaces

### Summary Data

```typescript
interface SummaryData {
  totals: {
    canonical: number;
    archive_candidates: number;
    unreviewed: number;
    total: number;
  };
  path_buckets: {
    ssot: number;
    archive: number;
    other: number;
  };
  generated_at: string; // RFC3339
}
```

### Canonical Document

```typescript
interface CanonicalDocument {
  path: string;
  title: string | null;
  doc_type: string | null; // "ssot" | "reference" | "runbook" | "legacy" | "unknown"
  status: string; // "canonical"
  is_canonical: boolean; // always true
  last_modified: string; // RFC3339
  size_bytes: number;
}

interface CanonicalList {
  items: CanonicalDocument[];
  total: number;
  generated_at: string; // RFC3339
}
```

### Archive Candidate Group

```typescript
interface ArchiveCandidateGroup {
  directory: string;
  count: number;
  example_paths: string[]; // up to 3 examples
  confidence: "safe_cluster" | "mixed_cluster";
  notes: string;
}

interface ArchiveCandidates {
  groups: ArchiveCandidateGroup[];
  total_groups: number;
  total_items: number;
  generated_at: string; // RFC3339
}
```

### Unreviewed Document

```typescript
interface UnreviewedDocument {
  path: string;
  doc_type: string | null;
  status: string; // "unreviewed"
  title: string | null;
  snippet: string; // first 200 chars
  guess: string; // heuristic guess
  last_modified: string; // RFC3339
}

interface UnreviewedBatch {
  batch_id: string;
  items: UnreviewedDocument[];
  batch_size: number;
  remaining_estimate: number;
  generated_at: string; // RFC3339
}
```

### Orphan Item

```typescript
interface OrphanItem {
  path: string;
  type: "file" | "directory";
  size_bytes?: number; // for files
  item_count?: number; // for directories
}

interface OrphanCategory {
  name: string; // "backup_bundles" | "evidence_snapshots" | "stray_files" | "stray_dirs"
  description: string;
  items: OrphanItem[];
}

interface Orphans {
  categories: OrphanCategory[];
  generated_at: string; // RFC3339
}
```

### Archive Dry-Run Item

```typescript
interface ArchiveDryRunItem {
  from: string;
  to: string;
  reason: string;
  size_bytes: number;
}

interface ArchiveDryRunGroup {
  directory: string;
  count: number;
  total_size_bytes: number;
}

interface ArchiveDryRun {
  total_candidates: number;
  items: ArchiveDryRunItem[];
  groups: ArchiveDryRunGroup[];
  generated_at: string; // RFC3339
}
```

## Error Handling Contract

### File Not Found

- **Condition**: JSON export file missing (e.g., `share/exports/docs-control/summary.json` not found)
- **Frontend Response**: Show loading error with "Refresh Data" button
- **Recovery**: Operator runs `pmagent docs dashboard-refresh` to generate exports

### Invalid JSON

- **Condition**: Malformed JSON in export files
- **Frontend Response**: Parse error display with file path and error details
- **Recovery**: Check `pmagent docs dashboard-refresh` output for errors; re-run refresh

### Empty Data

- **Condition**: Valid JSON but empty arrays (e.g., `items: []`, `groups: []`)
- **Frontend Response**: Show "No data available" message with context
- **Recovery**: Normal state if database is empty; otherwise check DB connection

### Stale Data

- **Condition**: `generated_at` timestamp is > 24 hours old
- **Frontend Response**: Show warning banner: "Data is stale (last refreshed: {timestamp}). Refresh recommended."
- **Recovery**: Operator runs `pmagent docs dashboard-refresh`

### Database Unavailable

- **Condition**: `pmagent docs dashboard-refresh` fails with DB connection error
- **Backend Response**: Export files may be missing or contain error placeholders
- **Frontend Response**: Show "Database unavailable" error with instructions to check DB connection

## Performance Contract

### Data Volume Expectations

- **Summary**: < 1 KB (instant load)
- **Canonical List**: 177 items ≈ 50 KB (instant load)
- **Archive Candidates**: 12 groups ≈ 10 KB (instant load)
- **Unreviewed Batch**: 20 items ≈ 15 KB (instant load)
- **Orphans**: Variable, typically < 20 KB (instant load)
- **Archive Dry-Run**: 689 items ≈ 200 KB (< 1s load)

### Frontend Rendering

- **Summary Tiles**: Instant render (< 100ms)
- **Canonical Table**: 177 rows, client-side filtering (< 500ms)
- **Archive Groups**: 12 group cards (< 200ms)
- **Unreviewed Batch**: 20 items with snippets (< 300ms)
- **Orphans Categories**: Variable, typically < 100ms
- **Archive Dry-Run**: 689 items, grouped view (< 1s)

### Refresh Performance

- **Full Refresh**: `pmagent docs dashboard-refresh` should complete in < 5 seconds
- **Incremental Refresh** (future): Only regenerate changed exports

## Version Compatibility

### Data Format Versions

- **v1.0**: Initial implementation (current)
- **Backwards Compatibility**: Frontend must handle missing optional fields gracefully
- **Forward Compatibility**: New fields in JSON are ignored by frontend (no breaking changes)

### Breaking Changes

- **Field Removal**: Requires frontend update and contract version bump
- **Type Changes**: Requires frontend update and contract version bump
- **Required Field Addition**: Requires frontend update and contract version bump

## Development Workflow

### Local Development

```bash
# Backend: Generate fresh JSON exports
pmagent docs dashboard-refresh

# Frontend: Start dev server (future Phase 2)
cd webui/docs-control
npm run dev  # Opens localhost:5173
```

### Data Synchronization

1. Operator runs `pmagent docs dashboard-refresh` to generate fresh exports
2. Frontend loads JSON files from `share/exports/docs-control/`
3. Manual browser refresh if data changes during development

## Mapping to Database Schema

### `control.kb_document` Table

| Column | Type | Description | Used In |
|--------|------|-------------|---------|
| `id` | uuid | Primary key | Not exported (internal) |
| `path` | text | Repo-relative path | All exports |
| `title` | text | Document title | Canonical, Unreviewed |
| `doc_type` | text | Document type | Canonical, Unreviewed |
| `project` | text | Project identifier | Not exported (filtered) |
| `content_hash` | text | SHA-256 hash | Not exported (internal) |
| `size_bytes` | integer | File size | Canonical, Archive Dry-Run |
| `mtime` | timestamptz | Last modified | Canonical, Unreviewed |
| `referenced_by` | text[] | Referencing paths | Not exported (future) |
| `is_canonical` | boolean | Canonical flag | Summary, Canonical |
| `status` | text | Review status | Summary, Archive Candidates, Unreviewed |
| `created_at` | timestamptz | Creation timestamp | Not exported (internal) |
| `updated_at` | timestamptz | Update timestamp | Not exported (internal) |

### Status Values

- `unreviewed`: Document not yet classified (default)
- `canonical`: Document is the canonical version (for duplicates)
- `archive_candidate`: Document is a candidate for archiving
- `legacy`: Document is legacy but kept for reference

### Doc Type Values

- `ssot`: Single Source of Truth document
- `reference`: Reference documentation
- `runbook`: Operational runbook
- `legacy`: Legacy documentation
- `unknown`: Type not determined

## Related Documentation

- **DM-002 Plan**: `docs/SSOT/DM_002_PLAN.md` - Classification heuristics and workflow
- **PM Contract**: `docs/SSOT/PM_CONTRACT_STRICT_SSOT_DMS.md` - PM behavior and DMS usage
- **Cursor Workflow**: `docs/SSOT/CURSOR_WORKFLOW_CONTRACT.md` - Cursor execution patterns
- **WebUI Contract**: `docs/SSOT/webui-contract.md` - Graph visualization data contract (reference pattern)
- **Migration 048**: `migrations/048_control_kb_document.sql` - Database schema definition
- **Migration 049**: `migrations/049_control_kb_document_dm002.sql` - DM-002 schema additions

## Future Enhancements (Phase 2)

### Real-Time API

- Replace JSON file exports with HTTP API endpoints
- Support query parameters for filtering and pagination
- WebSocket updates for real-time data changes

### Write-Back Operations

- `POST /api/docs/update-status` - Update document status
- `POST /api/docs/mark-canonical` - Mark document as canonical
- `POST /api/docs/archive-apply` - Execute archive moves with receipts

### Advanced Filtering

- Full-text search across document titles and snippets
- Date range filtering for `last_modified`
- Multi-select filters for `doc_type` and `status`

### Batch Operations

- Bulk status updates (mark multiple docs as archive_candidate)
- Batch canonical selection (select canonical from duplicate group)
- Archive plan execution with progress tracking

