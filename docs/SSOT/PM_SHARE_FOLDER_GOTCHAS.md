# PM Share Folder Gotchas Analysis

**Date**: 2025-11-29  
**Context**: PM is having issues inferring current project status from share folder JSON files  
**Related**: Rule 071 (Portable JSON is not Plan SSOT), PM_CONTRACT_STRICT_SSOT_DMS.md Section "Planning Context vs Portable Snapshots"

---

## Executive Summary

The PM is incorrectly trying to infer the current active Phase/PLAN from the `share/` folder JSON files. These files are **incomplete snapshots** (first 100 lines only) and **stale exports** that do not reflect the true current state. The PM should instead use the **planning system** (`pmagent plan next`, `pmagent plan history`, `pmagent plan reality-loop`) to get accurate, up-to-date project status.

---

## Critical Gotchas

### 1. Share Folder JSON Files Are "Head" Exports Only (Incomplete)

**Problem**: The `share/*.head.json` files are generated by `scripts/util/export_head_json.py`, which extracts only the **first 100 lines** of source files.

**Evidence**:
- `share/next_steps.head.json` contains only first 100 lines of `NEXT_STEPS.md`
- `share/pm_contract.head.json` contains only first 100 lines of `PM_CONTRACT.md`
- `share/agents_md.head.json` contains only first 100 lines of `AGENTS.md`

**Impact**: 
- `NEXT_STEPS.md` is 156 lines long - the head export misses the "Next Gate / Next Steps" section (lines 114-156)
- The PM sees "Phase 9B" mentioned in the head (line 112) but doesn't see that it's marked as "✅ COMPLETE" in the full file
- The PM cannot see the actual current focus or next steps from incomplete snapshots

**Fix**: PM must read the full source files, not rely on head exports for planning decisions.

---

### 2. Share Folder Contains Stale Information

**Problem**: The share folder JSON files are generated during `make housekeeping` but may not reflect the most recent state.

**Evidence**:
- `share/next_steps.head.json` shows "Phase 9B" as if it's active
- Actual `NEXT_STEPS.md` shows "PLAN-098 Phase-9B ✅ **VERIFIED COMPLETE** (2025-11-23)"
- The head export was generated before the completion status was added

**Impact**: PM infers wrong phase status from stale exports.

**Fix**: PM must treat share folder JSON as **advisory only** for governance/posture, never for phase/plan selection.

---

### 3. Planning System Exists But Isn't Being Used

**Problem**: The `pmagent/plan/` system provides accurate, up-to-date planning information but the PM isn't using it.

**Available Commands**:
- `pmagent plan next` - Returns current focus, next milestone, and candidates from MASTER_PLAN.md + NEXT_STEPS.md
- `pmagent plan next --with-status` - Includes system posture (reality-check + status explain)
- `pmagent plan open <candidate_id>` - Opens a capability session envelope for a specific work item
- `pmagent plan reality-loop` - Picks highest-priority candidate and writes capability_session envelope
- `pmagent plan history` - Lists recent capability_session envelopes

**What It Does**:
- Reads **full** `MASTER_PLAN.md` and `NEXT_STEPS.md` files (not head exports)
- Extracts `Current Focus` and `Next Milestone` from MASTER_PLAN.md
- Extracts candidates from the last "# Next Gate" or "# Next Steps" section in NEXT_STEPS.md
- Optionally includes system posture (DB/LM health, reality-check verdict)

**Impact**: PM is reinventing the wheel by trying to parse JSON snapshots instead of using the built-in planning system.

**Fix**: PM must use `pmagent plan next --with-status` as the primary source for "what to work on next".

---

### 4. PM Contract Rules Exist But Aren't Being Followed

**Problem**: Rule 071 and PM_CONTRACT_STRICT_SSOT_DMS.md Section "Planning Context vs Portable Snapshots" explicitly forbid inferring active Phase/PLAN from portable JSON, but the PM is doing exactly that.

**Rules**:
- Rule 071: "Portable JSON is not Plan SSOT"
- PM_CONTRACT_STRICT_SSOT_DMS.md: "The PM is **forbidden** to choose or infer the currently active Phase or PLAN solely from these portable JSON snapshots"
- PM_CONTRACT.md Section 2.7: "When deciding 'what to work on next' at the Phase/PLAN level, I must not rely on the portable `share/*.json` snapshots alone"

**Impact**: PM is violating its own contract by using share folder JSON for phase selection.

**Fix**: PM must follow the contract hierarchy:
1. Orchestrator's explicit statement (e.g., "we're on Phase 14 and 15")
2. `docs/SSOT/MASTER_PLAN.md` (full file)
3. Full `NEXT_STEPS.md` (not head export)
4. `pmagent plan next` output

---

### 5. Share Folder Purpose Is Misunderstood

**Problem**: The PM thinks the share folder is a "complete planning brain" when it's actually a "portable governance/status snapshot".

**Intended Purpose** (from PM_CONTRACT_STRICT_SSOT_DMS.md):
- ✅ Status/posture/governance snapshots
- ✅ DMS registry state
- ✅ Hint registry
- ✅ Governance freshness
- ✅ System health posture
- ❌ **NOT** for roadmap/phase selection

**Actual Usage** (incorrect):
- PM tries to infer current phase from `next_steps.head.json`
- PM tries to infer active PLAN from `pm_snapshot.json`
- PM treats share folder as authoritative for "what to work on next"

**Fix**: Clarify in contracts that share folder is **governance/status only**, never for planning decisions.

---

### 6. Planning System Not Integrated Into Workflow

**Problem**: The planning system exists but isn't part of the standard PM workflow.

**Current Workflow** (wrong):
1. PM reads `share/next_steps.head.json`
2. PM infers phase from incomplete snapshot
3. PM makes planning decisions based on stale data

**Intended Workflow** (from pmagent/plan/AGENTS.md):
1. PM runs `pmagent plan next --with-status`
2. PM gets accurate candidates from full NEXT_STEPS.md
3. PM opens capability session: `pmagent plan open NEXT_STEPS:1`
4. PM tracks session: `pmagent plan reality-loop --track-session`
5. PM views history: `pmagent plan history`

**Impact**: Planning system is built but unused, leading to PM making decisions from incomplete data.

**Fix**: Integrate planning system commands into PM workflow as the primary source for "what to work on next".

---

## Design Inconsistencies

### 1. Head Export Limitation Not Documented

**Issue**: `export_head_json.py` extracts only first 100 lines, but this limitation isn't clearly documented in the share folder structure.

**Fix**: Add explicit documentation that `*.head.json` files are **incomplete snapshots** and should not be used for planning decisions.

### 2. Share Folder Generation Not Tied to Planning System

**Issue**: `make pm.share.artifacts` generates head exports but doesn't call `pmagent plan next` to include accurate planning context.

**Fix**: Consider including `pmagent plan next --json-only` output in share folder as `planning_context.json` (full, not head).

### 3. No Clear "Current Phase" Signal in Share Folder

**Issue**: Share folder has governance/status but no explicit "current_phase" or "active_plan" field.

**Fix**: Either:
- Add `planning_context.json` to share folder (from `pmagent plan next`)
- Or document that share folder explicitly does NOT contain phase/plan info

---

## Integration Issues

### 1. PM Doesn't Know Planning System Exists

**Issue**: PM is trying to parse JSON manually instead of using `pmagent plan` commands.

**Fix**: Update PM contracts to explicitly require using `pmagent plan next` as the first step in any planning workflow.

### 2. Planning System Not in Makefile

**Issue**: No Makefile targets for planning system commands (e.g., `make plan.next`, `make plan.history`).

**Fix**: Add Makefile targets:
```makefile
plan.next:
	pmagent plan next --with-status

plan.history:
	pmagent plan history --limit 10
```

### 3. Planning System Not in PM Snapshot

**Issue**: `pmagent pm.snapshot` doesn't include planning context from `pmagent plan next`.

**Fix**: Include `planning_context` in `pm_snapshot.json` by calling `pmagent plan next --json-only`.

---

## Error Handling Gaps

### 1. No Validation That Share Folder Is Stale

**Issue**: No guard or check to detect when share folder JSON is out of sync with source files.

**Fix**: Add guard that compares `next_steps.head.json` timestamp with `NEXT_STEPS.md` mtime.

### 2. No Warning When Using Head Exports for Planning

**Issue**: PM contracts say "don't use JSON for planning" but there's no runtime check.

**Fix**: Add validation in planning system that warns if PM is using share folder JSON instead of `pmagent plan next`.

---

## Documentation Gaps

### 1. Share Folder Structure Not Clearly Documented

**Issue**: No clear documentation explaining what each share folder JSON file contains and what it's for.

**Fix**: Create `docs/SSOT/SHARE_FOLDER_STRUCTURE.md` explaining:
- What each file contains
- What it's for (governance/status vs planning)
- How to use it correctly

### 2. Planning System Usage Not Documented in PM Workflow

**Issue**: PM contracts mention planning system but don't show concrete workflow examples.

**Fix**: Add workflow examples to PM_CONTRACT.md showing:
- How to start a new planning session
- How to get current candidates
- How to track work sessions

---

## Recommendations

### Immediate Fixes (High Priority)

1. **Update PM contracts** to explicitly require `pmagent plan next` as the first step in planning workflows
2. **Add Makefile targets** for planning system commands
3. **Document share folder limitations** - add explicit warnings that `*.head.json` files are incomplete
4. **Add planning context to share folder** - include `pmagent plan next --json-only` output as `share/planning_context.json`

### Medium Priority

1. **Integrate planning system into PM snapshot** - include planning context in `pm_snapshot.json`
2. **Add guards** to detect stale share folder exports
3. **Create share folder structure documentation** - explain what each file is for
4. **Add workflow examples** to PM contracts showing proper planning system usage

### Long Term

1. **Deprecate head exports for planning** - consider full exports or planning system integration
2. **Automate planning context updates** - ensure `share/planning_context.json` is always fresh
3. **Add planning system to CI** - validate that planning system works in hermetic mode

---

## Related Files

- `pmagent/plan/next.py` - Planning system implementation
- `pmagent/plan/AGENTS.md` - Planning system documentation
- `scripts/util/export_head_json.py` - Head export utility (100 lines only)
- `docs/SSOT/PM_CONTRACT_STRICT_SSOT_DMS.md` - PM contract with planning rules
- `docs/SSOT/PM_CONTRACT.md` - PM contract Section 2.7
- `.cursor/rules/071-portable-json-not-plan-ssot.mdc` - Rule 071

---

## Verification Checklist

- [ ] PM uses `pmagent plan next --with-status` instead of reading share folder JSON
- [ ] PM reads full `MASTER_PLAN.md` and `NEXT_STEPS.md` for phase/plan decisions
- [ ] Share folder JSON is treated as governance/status only, never for planning
- [ ] Planning system is integrated into PM workflow
- [ ] Makefile targets exist for planning system commands
- [ ] PM snapshot includes planning context
- [ ] Share folder structure is documented
- [ ] Guards detect stale share folder exports

