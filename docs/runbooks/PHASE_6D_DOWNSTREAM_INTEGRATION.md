# Phase-6D: Downstream App Read-Only Wiring

**Status**: âœ… Complete  
**Scope**: Control-plane export adapters for StoryMaker and BibleScholar  
**Dependencies**: Phase-6P (BibleScholar Reference Slice), Phase-078 E90 (Graph Compliance Metrics)

## Overview

Phase-6D provides hermetic, fail-closed adapters for downstream apps (StoryMaker, BibleScholar) to consume control-plane exports:

- **Graph Compliance Metrics** (`graph_compliance.json`)
- **BibleScholar Reference Questions/Answers** (`biblescholar_reference.json`)
- **LM Indicator** (already integrated in Phase-5)

All adapters are read-only, file-based, and fail-closed (offline-safe defaults when files are missing or invalid).

## Adapter Module

**Location**: `agentpm/control_widgets/adapter.py`

### Functions

#### `load_graph_compliance_widget_props() -> GraphComplianceWidgetProps`

Loads graph compliance metrics from `share/atlas/control_plane/graph_compliance.json` and returns widget props:

```python
{
    "status": "ok" | "degraded" | "unknown",
    "label": str,  # Human-readable status
    "color": "green" | "yellow" | "grey",
    "icon": str,  # Icon name
    "tooltip_lines": List[str],  # Tooltip content
    "metrics": {
        "totalRunsWithViolations": int,
        "byTool": Dict[str, int],
        "byNode": Dict[str, int],
        "byPattern": Dict[str, int],
        "byBatch": Dict[str, int],
        "windowDays": int,
        "generatedAt": str,
    },
    "source": {"path": str},
}
```

#### `load_biblescholar_reference_widget_props() -> BibleScholarReferenceWidgetProps`

Loads BibleScholar reference data from `share/atlas/control_plane/biblescholar_reference.json` and returns widget props:

```python
{
    "status": "active" | "empty" | "unknown",
    "label": str,  # Human-readable status
    "color": "green" | "grey",
    "icon": str,  # Icon name
    "tooltip_lines": List[str],  # Tooltip content
    "metrics": {
        "totalQuestions": int,
        "byMode": Dict[str, int],
        "byVerseRef": Dict[str, int],
        "windowDays": int,
        "generatedAt": str,
    },
    "source": {"path": str},
}
```

## Integration Guide for Downstream Apps

### StoryMaker Integration

**Example**: Add a graph compliance card to StoryMaker dashboard

```typescript
import { load_graph_compliance_widget_props } from '@gemantria/control_widgets';

// In your component
const complianceProps = load_graph_compliance_widget_props();

// Render card
<Card>
  <CardHeader>
    <CardTitle>{complianceProps.label}</CardTitle>
  </CardHeader>
  <CardContent>
    <StatusBadge 
      status={complianceProps.status}
      color={complianceProps.color}
      icon={complianceProps.icon}
    />
    <Tooltip content={complianceProps.tooltip_lines}>
      <InfoIcon />
    </Tooltip>
    <MetricsDisplay metrics={complianceProps.metrics} />
  </CardContent>
</Card>
```

### BibleScholar Integration

**Example**: Add a reference activity badge to BibleScholar header

```typescript
import { load_biblescholar_reference_widget_props } from '@gemantria/control_widgets';

// In your header component
const referenceProps = load_biblescholar_reference_widget_props();

// Render badge
<HeaderBadge
  status={referenceProps.status}
  label={referenceProps.label}
  color={referenceProps.color}
  icon={referenceProps.icon}
  tooltip={referenceProps.tooltip_lines}
/>
```

## Adapter Guarantees

1. **Hermetic**: File-only, no DB/LM calls
2. **Fail-closed**: Offline-safe defaults when files are missing or invalid
3. **Zero heuristics**: Classification is upstream (control-plane exports)
4. **Type-safe**: TypedDict contracts for widget props

## Export File Locations

- `share/atlas/control_plane/graph_compliance.json` (generated by `make control.graph.compliance.export`)
- `share/atlas/control_plane/biblescholar_reference.json` (generated by `make control.biblescholar.reference.export`)
- `share/atlas/control_plane/lm_indicator.json` (generated by `make control.lm.indicator.export`)

## Testing

**Test suite**: `agentpm/tests/control_widgets/test_adapter.py`

Run tests:
```bash
pytest agentpm/tests/control_widgets/test_adapter.py -v
```

Tests cover:
- Healthy data (no violations, active questions)
- Degraded data (violations present, empty questions)
- Missing files (offline-safe defaults)
- Invalid JSON (offline-safe defaults)

## Status Snapshot Integration

The system snapshot (`pmagent status snapshot` or `/api/status/system`) includes control-plane widget summaries:

```json
{
  "control_widgets": {
    "graph_compliance": {
      "status": "ok",
      "label": "Graph compliance: No violations",
      "metrics": {
        "totalRunsWithViolations": 0,
        "windowDays": 30
      }
    },
    "biblescholar_reference": {
      "status": "active",
      "label": "BibleScholar: 10 question(s)",
      "metrics": {
        "totalQuestions": 10,
        "windowDays": 30
      }
    }
  }
}
```

## Related Documentation

- **Phase-5**: LM Indicator Widget Integration (`docs/SSOT/PHASE_5_PLAN.md`)
- **Phase-6P**: BibleScholar Reference Answer Slice (`docs/SSOT/BIBLESCHOLAR_REFERENCE_SLICE.md`)
- **Phase-078 E90**: Compliance Metrics in Graph Stats (`docs/SSOT/MASTER_PLAN.md`)
- **LM Widgets Contract**: `docs/SSOT/LM_WIDGETS.md`

## Make Targets

- `make control.graph.compliance.export` - Generate graph compliance export
- `make guard.control.graph.compliance` - Validate graph compliance export
- `make control.biblescholar.reference.export` - Generate BibleScholar reference export
- `make guard.biblescholar.reference` - Validate BibleScholar reference export

## Next Steps

1. **StoryMaker**: Integrate graph compliance card (see example above)
2. **BibleScholar**: Integrate reference activity badge (see example above)
3. **Both Apps**: Ensure exports are synced to app repos (via `share/` directory or CI sync)

