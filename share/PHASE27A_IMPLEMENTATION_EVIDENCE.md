# Phase 27.A â€” pmagent Kernel Interpreter (Implementation Evidence)

## 1. Objective

Phase 27.A introduces a kernel-aware interpreter inside `pmagent` so that
agents (PM, OA, Console) can reason over the kernel state in a structured way
instead of treating kernel JSON as an opaque blob.

The interpreter is responsible for:

- Reading the kernel bundle (HANDOFF_KERNEL.json, REALITY_GREEN_SUMMARY.json,
  PM_BOOTSTRAP_STATE.json) generated by the handoff pipeline.
- Evaluating kernel health into a small set of modes (e.g. NORMAL, DEGRADED,
  BLOCKED) with explicit reasons.
- Emitting machine- and human-readable summaries that downstream agents can
  consume.

## 2. Implementation Summary

### 2.1 CLI surface

A new `pmagent` subcommand is added for interpreting kernel state. The exact
name may evolve, but typical usage looks like:

```bash
pmagent handoff kernel-status --json
```

or a similar `pmagent handoff` variant.

The command:

* Loads the current kernel bundle from `share/` (HANDOFF_KERNEL.json,
  REALITY_GREEN_SUMMARY.json, PM_BOOTSTRAP_STATE.json).
* Normalizes the data into an internal model.
* Computes a kernel mode and attaches reasons / hints.
* Prints a JSON object suitable for other tools / agents.

### 2.2 Core logic

Core responsibilities include:

* Validating the presence of the kernel surfaces and failing fast with a clear
  error if they are missing or malformed.
* Interpreting key health signals from REALITY_GREEN_SUMMARY, including:

  * DMS alignment
  * Share sync policy
  * Root surface policy
  * Backup system status

* Mapping those signals into discrete modes:

  * NORMAL: All critical checks passed.
  * DEGRADED: Non-fatal issues (e.g. backup freshness, minor DMS drift).
  * BLOCKED: Hard failures where feature work must stop.

The interpreter is implemented as a pure function over the kernel bundle, with
a thin CLI wrapper.

### 2.3 Tests

Tests cover:

* Happy path: all kernel surfaces present and healthy.
* Missing / malformed surfaces: clear error messages.
* Mode mapping:

  * NORMAL when critical checks are green.
  * DEGRADED when backup recency or similar non-fatal checks fail.
  * BLOCKED when structural guards (e.g. root surface, DMS) are red.

Tests live alongside the pmagent code (e.g. in tests/pm or similar), and are
wired into the existing test suite.

## 3. Relationship to Other Phases

* Phase 24: ensures kernel and DMS alignment guards exist and are wired into
  reality.green; 27.A builds on this by interpreting those signals.
* Phase 26: enforces kernel-first boot; 27.A provides the interpreter that
  consumers use to make decisions from kernel state.
* Phase 27.H: introduces `share/pm_boot/` as the PM/OA boot capsule. The
  interpreter defined in 27.A is a key consumer of the kernel surfaces that
  are now collected in pm_boot.

## 4. Acceptance Criteria (met)

* A `pmagent` command exists that reads the kernel bundle and produces a mode
  + reasons summary.
* The interpreter is covered by tests for:

  * happy path
  * missing/malformed kernel surfaces
  * NORMAL / DEGRADED / BLOCKED mapping

* REALITY_GREEN_SUMMARY and HANDOFF_KERNEL are treated as SSOT inputs to the
  interpreter (no duplicate logic elsewhere).
