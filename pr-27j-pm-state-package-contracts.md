# Phase 27.J — PM State Package Contracts and pm_boot Export

## Summary

This PR replaces the fragile "new-chat handoff" behavior with a robust,
contract-defined **PM State Package** pattern, and ensures that the spec is
exported into `share/pm_boot/` for every PM/OA boot.

New PM chats are now expected to start with a neutral, data-only "PM State
Package", not with meta-handoff instructions. The PM treats that package as
state, loads kernel + pm_boot, and immediately moves to confirmation + OPS.

## Changes

### 1. New spec: PM_STATE_PACKAGE_SPEC.md

- Added `docs/SSOT/PM_STATE_PACKAGE_SPEC.md`:

  - Defines the required sections of a PM State Package:

    - Role

    - Truth Sources (kernel + SSOT surfaces)

    - Governance Contracts

    - Active Phase & Branch

    - Planning Surfaces

    - System Health Snapshot

    - Next Required Work (high-level)

  - Defines behavioral rules:

    - PM must **not** generate another handoff when seeing a State Package.

    - PM must load kernel/pm_boot, confirm briefly, then issue the next OPS block.

### 2. PM boot contract hooked to the State Package

- Updated `docs/SSOT/PM_BOOT_CONTRACT.md`:

  - Added "Chat Restart Protocol (PM State Package)" section.

  - Clarifies:

    - New PM chats are initialized by pasting a PM State Package.

    - The PM treats that as state, not as a prompt for another handoff.

    - This supersedes the older PM_HANDOFF_PROTOCOL-style behavior.

### 3. PM behavior contracts updated

- `docs/SSOT/PM_BEHAVIOR_CONTRACT.md`:

  - Added "On New Chats" section:

    - PM expects a State Package as first message.

    - PM responds with:

      - Short confirmation that state is loaded.

      - The next concrete OPS block (or explicit "No OPS" in rare cases).

- `docs/SSOT/PM_AND_OPS_BEHAVIOR_CONTRACT.md`:

  - Updated response mode rules:

    - When the first user message is a State Package:

      - PM → YOU section is minimal (one short confirmation).

      - PM → CURSOR (OPS block) is where real work is defined.

    - PM must not re-emit large "handoff" walls of text in response.

### 4. Cursor workflow contract integration

- `docs/SSOT/CURSOR_WORKFLOW_CONTRACT.md`:

  - Added "Producing PM State Packages" section:

    - PM may ask Cursor to assemble an updated State Package.

    - Cursor pulls kernel + REALITY_GREEN_SUMMARY.json + SSOT docs and writes

      a draft (e.g., `pr-XX-state-package.md`) for the Orchestrator to paste.

### 5. Execution contract note

- `docs/SSOT/EXECUTION_CONTRACT.md`:

  - Added a short note (Section 5.5):

    - PM State Package preparation is an OPS task for Cursor.

    - The Orchestrator should not manually reconstruct state from memory.

### 6. pm_boot export

- `scripts/pm/generate_pm_boot_surface.py`:

  - Now exports:

    - `docs/SSOT/PM_STATE_PACKAGE_SPEC.md` → `share/pm_boot/PM_STATE_PACKAGE_SPEC.md`

  - Ensures every pm_boot capsule contains the canonical spec.

- `share/pm_boot/PM_STATE_PACKAGE_SPEC.md`:

  - Generated by the updated pm_boot generator.

## Health

- `python scripts/guards/guard_pm_boot_surface.py`:

  - `{"ok": true, "missing_required": []}`

- `make ops.kernel.check`:

  - Passes for pm_boot-related checks (DB-dependent checks may still fail in

    hermetic/offline environments and are treated as expected in those modes).

## Rationale

This change eliminates the recurring failure mode where new PM chats respond
to a "handoff" by generating *another* handoff, instead of continuing work.
By making the PM State Package a first-class, spec'd artifact, and by wiring
it into both contracts and pm_boot, new chats can boot reliably and predictably.
